<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bootstrap demo</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="FeedPage.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="text-end p-2">
      <a href="Post.html" class="btn btn-primary w-10">New Post</a>
      <button onclick="logout()" class="btn btn-danger w-10">Logout</button>
    </div>

    <div class="allPosts" id="postsContainer">
      <!-- Posts will be dynamically loaded here -->
      <div id="loadingMessage" class="text-center">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading your posts...</p>
      </div>
      <div id="noPostsMessage" class="text-center" style="display: none">
        <h3>No posts found</h3>
        <p>
          You haven't created any posts yet.
          <a href="Post.html" class="btn btn-primary">Create your first post</a>
        </p>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"
      integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y"
      crossorigin="anonymous"
    ></script>

    <script>
      // Check if user is logged in
      const userID =
        localStorage.getItem("userID") || sessionStorage.getItem("userID");

      if (!userID) {
        // Redirect to login if no userID found
        alert("Please login to view your posts");
        window.location.href = "login.html";
      }

      // Function to fetch and display posts
      async function loadUserPosts() {
        const loadingMessage = document.getElementById("loadingMessage");
        const noPostsMessage = document.getElementById("noPostsMessage");
        const postsContainer = document.getElementById("postsContainer");

        try {
          const response = await fetch(
            `http://localhost:3000/getMyPosts?userID=${userID}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error("Failed to fetch posts");
          }

          const posts = await response.json();

          // Hide loading message
          loadingMessage.style.display = "none";

          if (posts.length === 0) {
            // Show no posts message
            noPostsMessage.style.display = "block";
          } else {
            // Display posts
            displayPosts(posts);
          }
        } catch (error) {
          console.error("Error fetching posts:", error);
          loadingMessage.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <h4 class="alert-heading">Error!</h4>
                        <p>Failed to load posts. Please try again later.</p>
                        <button class="btn btn-outline-danger" onclick="loadUserPosts()">Retry</button>
                    </div>
                `;
        }
      }

      // Function to display posts
      function displayPosts(posts) {
        const postsContainer = document.getElementById("postsContainer");

        // Clear existing content
        postsContainer.innerHTML = "";

        posts.forEach((post) => {
          const postElement = document.createElement("div");
          postElement.className = "Post";

          // Format date if available
          let postDate = "";
          if (post.createdAt) {
            postDate = new Date(post.createdAt).toLocaleDateString();
          }

          postElement.innerHTML = `
                    <h1>${escapeHtml(post.postTitle)}</h1>
                    ${
                      postDate
                        ? `<small class="text-muted">Posted on: ${postDate}</small>`
                        : ""
                    }
                    <p>${escapeHtml(post.postDescription)}</p>
                    <button class="btn ViewPostButton text-white" onclick="viewPost(${
                      post.ID
                    })">View Post</button>
                `;

          postsContainer.appendChild(postElement);
        });
      }

      // Function to escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Function to view individual post (you can customize this)
      function viewPost(postID) {
        // Store post ID and redirect to dedicated page
        localStorage.setItem("currentPostID", postID);
        window.location.href = "DedicatedPage.html";
      }

      // Function to handle logout
      function logout() {
        localStorage.removeItem("userID");
        sessionStorage.removeItem("userID");
        localStorage.removeItem("currentPostID");
        window.location.href = "login.html";
      }

      // Load posts when page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadUserPosts();
      });
    </script>
  </body>
</html>
